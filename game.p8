pico-8 cartridge // http://www.pico-8.com
version 32
__lua__
function _init()
  game = {}
  start_game()
end

function _update()
  game.update()
end

function _draw()
  game.draw()
end

function start_game()
  game.update = game_update
  game.draw = game_draw

  #include global_variables.lua
  #include blink.lua
  #include camera.lua
  #include fruits.lua
  #include deck.lua
  #include selected_card.lua

  selected_card:place_starting_card()
end

function game_update() 
  selected_card:update()
  adjust_selected_card_or_camera_position(selected_card,cam)
  camera(cam.x0,cam.y0)
  blink:update()
end

function game_draw()
  cls(5)
  rectfill(orchard_x0,orchard_y0,orchard_x1,orchard_y1,3)
  background_pattern = {}
  bg_color = 3
  for x=orchard_x0,orchard_x1 - 16,16 do
    if bg_color == 3 then 
      bg_color = 11
    else
      bg_color = 3
    end
    local next_x = x
    for y=orchard_y0,orchard_y1 - 16,16 do
      local next_y = y
      local coordinates = { x0 = next_x, y0 = next_y, col = bg_color }

      add(background_pattern,coordinates)
      if bg_color == 3 then 
        bg_color = 11
      else
        bg_color = 3
      end
    end
  end

  for square in all(background_pattern) do
    local x0 = square.x0
    local y0 = square.y0
    rectfill(x0,y0,calculate_x1(x0,16),calculate_y1(y0,16),square.col)
  end

  for fruit in all(planted_fruits) do
    pal(spritesheet_fruit_color,fruit.color)
    spr(fruit:sprite(),fruit.x,fruit.y,fruit_sprite_width,fruit_sprite_height)
  end
  selected_card:draw()
  print('card:'..selected_card.card_number..'/'..deck.count_after_first_card_placement,cam.x0 + 1,cam.y0 + 1,7)
  print('score:'..score,cam.x0 + 1,cam.y0 + 7,7)
end

function game_over()
  game.update = game_over_update
  game.draw = game_over_draw
end

function game_over_update()
  if btnp(5) then start_game() end
end

function game_over_draw()
  cls()
  print('game over',cam.x0 + 1,cam.y0 + 1,7)
  print('final score:'..score,cam.x0 + 1,cam.y0 + 7,7)
  print('press x to replay',cam.x0 + 1,cam.y0 + 13,7)
end

#include shared_functions.lua

__gfx__
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000011110000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000000110000000000011bbbb1100000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000000000000000001bb10000000001bbbbbbbb10000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000001111000000000001bbbb100000001bb78bbbbbb1000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000001bbbb10000000001b78bbb1000001bbb88bbbbbbb100000000000000000000000000000000000000000000000000000000000000000
000000000000000000001b78bbb100000001bb88bbbb100001bbbbbbbb3bb3100000000000000000000000000000000000000000000000000000000000000000
00000007800000000001bb88bb331000001bbbbbbbb3310001bbbbbbb33b33100000000000000000000000000000000000000000000000000000000000000000
00000008800000000001bbbbbbb31000001bbbbbbbbb310001b3bbbbbbbbb3100000000000000000000000000000000000000000000000000000000000000000
00000011110100000001bbbb3b3310000013bbbb3bb331000133bbbbb3bb33100000000000000000000000000000000000000000000000000000000000000000
000000000000000000011bbbb331100000133b3bb333310000133bbb333331000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000113333110000000133333333100000013333333310000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000013333331000000001333333100000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000144244224100000002422224200000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000122424244221000000000000000000000000000000000000000000000000000000000000000000
